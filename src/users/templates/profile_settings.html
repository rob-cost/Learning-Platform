{% extends "base.html" %} {% block title %}Profile Settings{% endblock %}
<!-- leave it -->
{% block content%}

<div class="profile-settings-container">
  <h1>Profile Settings</h1>
  {% if messages %}
  <div class="messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <form method="post">
    {% csrf_token %} {% if form.errors %}
    <ul class="errorlist">
      {% for field, errors in form.errors.items %} {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %} {% endfor %}
    </ul>
    {% endif %}

    <div class="form-group">
      <label>Username</label>
      {{ form.username }} {% if form.username.errors %}
      <span class="error">{{ form.username.errors }}</span>
      {% endif %}
    </div>

    <div class="form-group">
      <label>First Name</label>
      {{ form.first_name }} {% if form.first_name.errors %}
      <span class="error">{{ form.first_name.errors }}</span>
      {% endif %}
    </div>

    <div class="form-group">
      <label>Last Name</label>
      {{ form.last_name }} {% if form.last_name.errors %}
      <span class="error">{{ form.last_name.errors }}</span>
      {% endif %}
    </div>

    <div class="form-group">
      <label>Email</label>
      {{ form.email }} {% if form.email.errors %}
      <span class="error">{{ form.email.errors }}</span>
      {% endif %}
    </div>
    <div class="button-group">
      <button type="submit" class="btn-save">Save</button>
      <a href="{%url 'profile_page'%}" class="btn-cancel_2">Cancel</a>
    </div>
  </form>

  <form
    method="POST"
    action="{% url 'delete_profile' %}"
    style="margin-top: 15px"
  >
    {% csrf_token %}
    <button
      type="submit"
      class="btn-delete"
      onclick="return confirm('Are you sure you want to delete your account? This action cannot be undone.');"
    >
      Delete Account
    </button>
  </form>

  <div class="signup-link">
    <p><a href="{%url 'password_change'%}">Change Password</a></p>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const usernameInput = document.querySelector("input[name='username']");
    const currentUsername = "{{request.user.username}}";

    if (usernameInput) {
      const feedback = document.createElement("span");
      feedback.className = "username-feedback";
      usernameInput.parentNode.appendChild(feedback);

      let typingTimer;
      const typingDelay = 500;

      usernameInput.addEventListener("input", function () {
        clearTimeout(typingTimer);
        const username = this.value.trim();

        if (username === currentUsername || username == "") {
          feedback.style.display = "none";
          return;
        }

        feedback.style.display = "inline";

        typingTimer = setTimeout(() => {
          checkUsernameAvailability(username, feedback);
        }, typingDelay);
      });
    }
  });

  async function checkUsernameAvailability(username, feedbackElement) {
    try {
      const response = await fetch(
        `/check-username/?username=${encodeURIComponent(username)}`
      );
      const data = await response.json();

      if (data.available) {
        feedbackElement.className = "username-feedback available";
        feedbackElement.textContent = "✓ Username available";
      } else {
        feedbackElement.className = "username-feedback taken";
        feedbackElement.textContent = "✗ Username already taken";
      }
    } catch (error) {
      console.error("Error checking username:", error);
      feedbackElement.style.display = "none";
    }
  }
</script>

{% endblock %}
